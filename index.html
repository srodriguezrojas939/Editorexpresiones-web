<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Matem√°tico Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Open+Sans:wght@400;600&display=swap');
        body { background: #fff; font-family: 'Open Sans', sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: #F2F2F2; padding: 30px; border-radius: 40px; width: 100%; max-width: 850px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 15px 40px rgba(0,0,0,0.05); position: relative; }
        .header { text-align: center; margin-bottom: 15px; width: 100%; position: relative; }
        .header h1 { font-family: 'Playfair Display', serif; font-size: 28px; margin: 0; }
        
        /* Nuevo Selector de Color Discreto */
        .color-wrapper { position: absolute; top: 0; right: 0; }
        .color-trigger { width: 25px; height: 25px; border-radius: 4px; border: 2px solid #ddd; cursor: pointer; background-color: #000; transition: 0.2s; }
        .color-trigger:hover { border-color: #999; }
        #hidden-color-input { position: absolute; top: 0; right: 0; width: 25px; height: 25px; opacity: 0; cursor: pointer; }

        /* Men√∫ de P√≠ldoras */
        /* BUSCA ESTO Y REEMPL√ÅZALO */
        .pill-menu { 
            display: flex; 
            flex-wrap: wrap;       /* Esta l√≠nea permite que bajen si no caben */
            gap: 8px; 
            margin-bottom: 15px; 
            width: 100%; 
            justify-content: center; 
            background: #e0e0e0; 
            padding: 10px;         
            border-radius: 25px;   
            box-sizing: border-box;
        }

        .pill-btn { 
            padding: 8px 18px; 
            border-radius: 20px; 
            border: none; 
            background: transparent; 
            font-weight: 600; 
            font-size: 12px;       
            cursor: pointer; 
            color: #666; 
            transition: 0.2s; 
            white-space: nowrap;   /* Evita que el nombre de la pildora se divida */
        }        .pill-btn.active { background: #fff; color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .grids-container { width: 100%; margin-bottom: 15px; }
        .symbol-grid { display: none; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; padding: 15px; background: #fff; border-radius: 20px; border: 1px solid #ddd; }
        .symbol-grid.active { display: grid; }

        /* Visor */
        .preview-box { background: white; border-radius: 25px; margin-bottom: 20px; width: 100%; min-height: 150px; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd; overflow: hidden; }
        #math-target { padding: 30px; display: inline-block; transition: opacity 0.2s; }

        /* Botones de S√≠mbolos */
        .btn-sym { background: #f9f9f9; border: 1px solid #eee; padding: 10px 5px; border-radius: 12px; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: 0.1s; }
        .btn-sym:hover { background: #000; color: #fff; border-color: #000; }
        .btn-sym b { font-size: 18px; margin-bottom: 4px; }
        .btn-sym span { font-size: 9px; font-weight: 700; text-transform: uppercase; opacity: 0.6; }

        /* √Årea de Texto y Acciones */
        textarea { width: 100%; padding: 20px; border-radius: 20px; border: 1px solid #ccc; font-size: 16px; font-family: 'Courier New', monospace; outline: none; resize: vertical; min-height: 100px; margin-bottom: 15px; text-align: center; }
        .actions { display: flex; gap: 10px; width: 100%; }
        select { padding: 15px; border-radius: 25px; border: 1px solid #ccc; flex: 1; font-weight: 600; outline: none; cursor: pointer; }
        .btn-dl { flex: 2; background: #000; color: #fff; border: none; padding: 15px; border-radius: 30px; font-size: 15px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-dl:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Editor de expresiones</h1>
        <div class="color-wrapper">
            <div class="color-trigger" id="color-trigger" title="Cambiar Color"></div>
            <input type="color" id="hidden-color-input" value="#000000">
        </div>
    </div>

    <div class="pill-menu" id="pill-menu"></div>
    <div class="grids-container" id="grids-container"></div>

    <div class="preview-box">
        <div id="math-target">\[ ... \]</div>
    </div>

    <textarea id="math-input" spellcheck="false" placeholder="Escribe c√≥digo LaTeX aqu√≠..."></textarea>

    <div class="actions">
        <select id="res-val">
            <option value="1.2">Calidad Baja</option>
            <option value="2.8" selected>Calidad Media</option>
            <option value="4.5">Calidad Alta</option>
        </select>
        <button class="btn-dl" onclick="optimizedExport()">Descargar PNG</button>
    </div>
</div>

<script>
    // ================= CONFIGURACI√ìN Y ESTADO =================
    const menus = {
        "Letras Griegas": [
            {n: 'Alpha', s: '\\alpha', i: 'Œ±'},
            {n: 'Beta', s: '\\beta', i: 'Œ≤'},
            {n: 'Gamma', s: '\\gamma', i: 'Œ≥'},
            {n: 'Delta', s: '\\delta', i: 'Œ¥'},
            {n: 'Epsilon', s: '\\epsilon', i: 'Œµ'},
            {n: 'Zeta', s: '\\zeta', i: 'Œ∂'},
            {n: 'Theta', s: '\\theta', i: 'Œ∏'},
            {n: 'Lambda', s: '\\lambda', i: 'Œª'},
            {n: 'Mu', s: '\\mu', i: 'Œº'},
            {n: 'Pi', s: '\\pi', i: 'œÄ'},
            {n: 'Rho', s: '\\rho', i: 'œÅ'},
            {n: 'Sigma', s: '\\sigma', i: 'œÉ'},
            {n: 'Tau', s: '\\tau', i: 'œÑ'},
            {n: 'Phi', s: '\\phi', i: 'œÜ'},
            {n: 'Omega', s: '\\omega', i: 'œâ'},
            {n: 'Delta M.', s: '\\Delta', i: 'Œî'},
            {n: 'Sigma M.', s: '\\Sigma', i: 'Œ£'},
            {n: 'Omega M.', s: '\\Omega', i: 'Œ©'}
        ],
        "Flechas": [
            {n: 'Derecha', s: '\\rightarrow', i: '‚Üí'},
            {n: 'Izquierda', s: '\\leftarrow', i: '‚Üê'},
            {n: 'Implica', s: '\\implies', i: '‚áí'},
            {n: 'Equival', s: '\\iff', i: '‚áî'},
            {n: 'Mapeo', s: '\\mapsto', i: '‚Ü¶'},
            {n: 'Arriba', s: '\\uparrow', i: '‚Üë'},
            {n: 'Abajo', s: '\\downarrow', i: '‚Üì'},
            {n: 'Doble Dir', s: '\\leftrightarrow', i: '‚Üî'},
            {n: 'Hacia', s: '\\to', i: '‚Üí'}
        ],
        "L√≥gica": [
            {n: 'Para todo', s: '\\forall ', i: '‚àÄ'},
            {n: 'Existe', s: '\\exists ', i: '‚àÉ'},
            {n: 'No existe', s: '\\nexists ', i: '‚àÑ'},
            {n: 'Pertenece', s: '\\in ', i: '‚àà'},
            {n: 'No pert.', s: '\\notin ', i: '‚àâ'},
            {n: 'Uni√≥n', s: '\\cup ', i: '‚à™'},
            {n: 'Intersec', s: '\\cap ', i: '‚à©'},
            {n: 'Vac√≠o', s: '\\emptyset', i: '‚àÖ'},
            {n: 'Subconj', s: '\\subset ', i: '‚äÇ'},
            {n: 'Incluido', s: '\\subseteq ', i: '‚äÜ'},
            {n: 'Tal que', s: '\\mid ', i: '|'},
            {n: 'Por tanto', s: '\\therefore ', i: '‚à¥'},
            {n: 'Porque', s: '\\because ', i: '‚àµ'},
            {n: 'Y (and)', s: '\\land ', i: '‚àß'},
            {n: 'O (or)', s: '\\lor ', i: '‚à®'},
            {n: 'Negaci√≥n', s: '\\neg ', i: '¬¨'}
        ],
        "Principales": [
            {n: 'Suma', s: '+', i: '+'},
            {n: 'Resta', s: '-', i: '-'},
            {n: 'Igual', s: '=', i: '='},
            {n: 'Punto', s: '\\cdot ', i: '¬∑'},
            {n: 'Por', s: '\\times ', i: '√ó'},
            {n: 'Divisi√≥n', s: '\\div ', i: '√∑'},
            {n: 'Fracci√≥n', s: '\\frac{a}{b}', i: '√∑'},
            {n: 'Potencia', s: '^{n}', i: 'x‚Åø'},
            {n: 'Sub√≠ndice', s: '_{n}', i: 'x‚Çô'},
            {n: 'M√°s-menos', s: '\\pm ', i: '¬±'},
            {n: 'Menos-m√°s', s: '\\mp ', i: '‚àì'},
            {n: 'Aproxim.', s: '\\approx ', i: '‚âà'},
            {n: 'Distinto', s: '\\neq ', i: '‚â†'},
            {n: 'Id√©ntico', s: '\\equiv ', i: '‚â°'},
            {n: 'Similar', s: '\\sim ', i: '‚àº'},
            {n: 'Proporc.', s: '\\propto ', i: '‚àù'}
        ],
        "Desigualdades": [
            {n: 'Menor que', s: '<', i: '<'},
            {n: 'Mayor que', s: '>', i: '>'},
            {n: 'Menor igual', s: '\\leq ', i: '‚â§'},
            {n: 'Mayor igual', s: '\\geq ', i: '‚â•'},
            {n: 'Mucho menor', s: '\\ll ', i: '‚â™'},
            {n: 'Mucho mayor', s: '\\gg ', i: '‚â´'},
            {n: 'No menor', s: '\\nless ', i: '‚âÆ'},
            {n: 'No mayor', s: '\\ngtr ', i: '‚âØ'},
            {n: 'Precede', s: '\\prec ', i: '‚â∫'},
            {n: 'Sigue', s: '\\succ ', i: '‚âª'}
        ],
        "C√°lculo": [
            {n: 'Integral', s: '\\int ', i: '‚à´'},
            {n: 'Int. Doble', s: '\\iint ', i: '‚à¨'},
            {n: 'Int. Triple', s: '\\iiint ', i: '‚à≠'},
            {n: 'Int. Cerrada', s: '\\oint ', i: '‚àÆ'},
            {n: 'Derivada', s: '\\frac{d}{dx}', i: 'd/dx'},
            {n: 'Deriv. n', s: '\\frac{d^{n}}{dx^{n}}', i: 'd‚Åø'},
            {n: 'Parcial', s: '\\frac{\\partial }{\\partial x}', i: '‚àÇ/‚àÇx'},
            {n: 'Parcial n', s: '\\frac{\\partial^{n} }{\\partial x^{n}}', i: '‚àÇ‚Åø'},
            {n: 'Nabla', s: '\\nabla ', i: '‚àá'},
            {n: 'Gradiente', s: '\\nabla f', i: 'grad'},
            {n: 'Divergencia', s: '\\nabla \\cdot ', i: 'div'},
            {n: 'Rotacional', s: '\\nabla \\times ', i: 'rot'},
            {n: 'Laplace', s: '\\mathcal{L}\\{ f(t) \\}', i: '‚Ñí'},
            {n: 'Laplace Inv', s: '\\mathcal{L}^{-1}\\{ F(s) \\}', i: '‚Ñí‚Åª¬π'},
            {n: 'L√≠mite', s: '\\lim_{x \\to \\infty}', i: 'lim'},
            {n: 'Sumatoria', s: '\\sum_{i=1}^{n}', i: '‚àë'},
            {n: 'Productoria', s: '\\prod_{i=1}^{n}', i: '‚àè'},
            {n: 'Deriv. Punto', s: '\\dot{x}', i: '·∫ã'},
            {n: 'Deriv. Prima', s: "f'(x)", i: "f'"}
        ],
        "Conjuntos": [
            {n: 'Pertenencia', s: '\\in ', i: '‚àà'},
            {n: 'No pertenencia', s: '\\notin ', i: '‚àâ'},
            {n: 'Uni√≥n', s: '\\cup ', i: '‚à™'},
            {n: 'Intersecci√≥n', s: '\\cap ', i: '‚à©'},
            {n: 'Vac√≠o', s: '\\emptyset ', i: '‚àÖ'},
            {n: 'Subconjunto', s: '\\subset ', i: '‚äÇ'},
            {n: 'Incluido', s: '\\subseteq ', i: '‚äÜ'},
            {n: 'No incluido', s: '\\nsubseteq ', i: '‚äà'},
            {n: 'Diferencia', s: '\\setminus ', i: '\\'},
            {n: 'Producto Cart.', s: '\\times ', i: '√ó'},
            {n: 'Potencia (P)', s: '\\mathcal{P}', i: 'ùí´'},
            {n: 'Naturales (N)', s: '\\mathbb{N}', i: '‚Ñï'},
            {n: 'Enteros (Z)', s: '\\mathbb{Z}', i: '‚Ñ§'},
            {n: 'Racionales (Q)', s: '\\mathbb{Q}', i: '‚Ñö'},
            {n: 'Reales (R)', s: '\\mathbb{R}', i: '‚Ñù'},
            {n: 'Complejos (C)', s: '\\mathbb{C}', i: '‚ÑÇ'},
            {n: 'Primos (P)', s: '\\mathbb{P}', i: '‚Ñô'}
        ],
        "Matrices/Sist": [
            {n: 'Sist. 2 eq', s: '\\begin{cases} x+y=1 \\\\ x-y=0 \\end{cases}', i: '{='},
            {n: 'Matriz ( )', s: '\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix}', i: '(M)'},
            {n: 'Matriz [ ]', s: '\\begin{bmatrix} a & b \\\\ c & d \\end{bmatrix}', i: '[M]'},
            {n: 'Determinante', s: '\\begin{vmatrix} a & b \\\\ c & d \\end{vmatrix}', i: '|M|'},
            {n: 'Vector', s: '\\vec{v}', i: 'v‚Éó'},
            {n: 'Versor', s: '\\hat{u}', i: '√ª'},
            {n: 'Norma', s: '\\| v \\|', i: '||v||'},
            {n: 'Traspuesta', s: 'A^{T}', i: 'A·µÄ'},
            {n: 'Inversa', s: 'A^{-1}', i: 'A‚Åª¬π'},
            {n: 'Puntos Horiz', s: '\\cdots ', i: '‚ãØ'},
            {n: 'Puntos Vert', s: '\\vdots ', i: '‚ãÆ'},
            {n: 'Puntos Diag', s: '\\ddots ', i: '‚ã±'},
            {n: 'Dimensi√≥n', s: '\\mathbb{R}^{n \\times m}', i: 'R‚ÅøÀ£·µê'}
        ],
        "Par√©ntesis": [
            {n: 'Par√©ntesis', s: '\\left(  \\right)', i: '( )'},
            {n: 'Corchetes', s: '\\left[  \\right]', i: '[ ]'},
            {n: 'Llaves', s: '\\left\\{  \\right\\}', i: '{ }'},
            {n: 'Absoluto', s: '\\left|  \\right|', i: '|x|'},
            {n: 'Norma', s: '\\left\\|  \\right\\|', i: '||x||'},
            {n: 'Angulares', s: '\\langle  \\rangle', i: '‚ü® ‚ü©'},
            {n: 'Suelo', s: '\\lfloor  \\rfloor', i: '‚åä ‚åã'},
            {n: 'Techo', s: '\\lceil  \\rceil', i: '‚åà ‚åâ'},
            {n: 'Izq. Abierta', s: '\\left(  \\right.', i: '( ...'},
            {n: 'Der. Abierta', s: '\\left.  \\right)', i: '... )'},
            {n: 'Solo Izq.', s: '\\left\\{  \\right.', i: '{ ...'},
            {n: 'Solo Der.', s: '\\left.  \\right\\}', i: '... }'}
        ],
        "Otros": [
            {n: 'Espacio', s: '\\: ', i: '‚ê£'},
            {n: 'Espacio L', s: '\\quad ', i: '‚ê£+'},
            {n: 'Infinito', s: '\\infty ', i: '‚àû'},
            {n: 'Texto', s: '\\text{ }', i: 'Abc'},
            {n: '√Ångulo', s: '\\angle ', i: '‚à†'},
            {n: 'Tri√°ngulo', s: '\\triangle ', i: '‚ñ≥'},
            {n: 'Perpendic.', s: '\\perp ', i: '‚ä•'},
            {n: 'Paralelo', s: '\\parallel ', i: '‚à•'},
            {n: 'Vector L', s: '\\overrightarrow{AB}', i: '‚ü∂'},
            {n: 'Vector I', s: '\\overleftarrow{AB}', i: '‚üµ'},
            {n: 'Sobre-llave', s: '\\overbrace{a+b}^{n}', i: '‚èû'},
            {n: 'Bajo-llave', s: '\\underbrace{a+b}_{n}', i: '‚èü'},
            {n: 'Barra sup.', s: '\\overline{x}', i: 'xÃÑ'},
            {n: 'Barra inf.', s: '\\underline{x}', i: 'x_'},
            {n: 'Sombrero L', s: '\\widehat{abc}', i: '√Ç'},
            {n: 'Grados', s: '^{\\circ}', i: '¬∞'},
            {n: 'Daga', s: '\\dagger ', i: '‚Ä†'},
            {n: 'Planck', s: '\\hbar ', i: '‚Ñè'}
        ]
        
        
    };
    let renderTimer;
    let currentColor = '#000000';
    const inputArea = document.getElementById('math-input');
    const display = document.getElementById('math-target');
    const colorInput = document.getElementById('hidden-color-input');
    const colorTrigger = document.getElementById('color-trigger');

    // ================= INICIALIZACI√ìN =================
    function init() {
        // Crear men√∫ de p√≠ldoras
        const pillContainer = document.getElementById('pill-menu');
        const gridsContainer = document.getElementById('grids-container');
        let first = true;
        for (let cat in menus) {
            // Crear bot√≥n de p√≠ldora
            let pill = document.createElement('button');
            pill.className = `pill-btn ${first ? 'active' : ''}`;
            pill.textContent = cat;
            pill.onclick = () => switchTab(cat);
            pillContainer.appendChild(pill);
            
            // Crear rejilla de s√≠mbolos
            let grid = document.createElement('div');
            grid.className = `symbol-grid ${first ? 'active' : ''}`;
            grid.id = `grid-${cat}`;
            menus[cat].forEach(item => {
                let b = document.createElement('button');
                b.className = 'btn-sym';
                b.onclick = () => insertSymbol(item.s);
                b.innerHTML = `<b>${item.i}</b><span>${item.n}</span>`;
                grid.appendChild(b);
            });
            gridsContainer.appendChild(grid);
            first = false;
        }

        // Configurar inputs
        inputArea.value = "\\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}";
        colorInput.addEventListener('input', updateColor);
        inputArea.addEventListener('input', () => {
            clearTimeout(renderTimer);
            renderTimer = setTimeout(render, 350);
        });
        render();
    }

    // ================= L√ìGICA DE INTERFAZ =================
    function switchTab(catName) {
        document.querySelectorAll('.pill-btn').forEach(b => b.classList.toggle('active', b.textContent === catName));
        document.querySelectorAll('.symbol-grid').forEach(g => g.classList.toggle('active', g.id === `grid-${catName}`));
    }

    function updateColor(e) {
        currentColor = e.target.value;
        colorTrigger.style.backgroundColor = currentColor;
        render();
    }

    function insertSymbol(code) {
        let s = inputArea.selectionStart;
        inputArea.value = inputArea.value.substring(0, s) + code + inputArea.value.substring(inputArea.selectionEnd);
        inputArea.focus();
        render();
    }

    // ================= RENDERIZADO Y EXPORTACI√ìN (INTACTOS) =================
    function render() {
        display.style.opacity = "0.4";
        const rawContent = inputArea.value || '\\text{...}';
        display.innerHTML = `\\[ \\color{${currentColor}}{${rawContent}} \\]`;
        MathJax.typesetPromise([display]).then(() => { display.style.opacity = "1"; });
    }

    async function optimizedExport() {
        const svg = display.querySelector('svg');
        if (!svg) return;
        const btn = document.querySelector('.btn-dl');
        btn.innerText = "Procesando...";
        const requestedScale = parseFloat(document.getElementById('res-val').value);
        const bbox = svg.viewBox.baseVal;
        const maxDimension = 4500; // L√≠mite de seguridad
        let finalScale = requestedScale;
        if (bbox.width * finalScale > maxDimension) finalScale = maxDimension / bbox.width;
        if (bbox.height * finalScale > maxDimension) finalScale = Math.min(finalScale, maxDimension / bbox.height);
        
        const canvas = document.createElement('canvas');
        const padding = 30 * finalScale;
        canvas.width = (bbox.width * finalScale) + padding;
        canvas.height = (bbox.height * finalScale) + padding;
        const ctx = canvas.getContext('2d');
        const svgData = new XMLSerializer().serializeToString(svg);
        const img = new Image();
        const blob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        img.onload = () => {
            ctx.drawImage(img, padding/2, padding/2, bbox.width * finalScale, bbox.height * finalScale);
            canvas.toBlob((b) => {
                const link = document.createElement('a');
                link.download = `math_formula_${Date.now()}.png`;
                link.href = URL.createObjectURL(b);
                link.click();
                URL.revokeObjectURL(url);
                btn.innerText = "Descargar PNG";
            }, 'image/png', 1.0);
        };
        img.src = url;
    }
    window.onload = init;
</script>
</body>
</html>
