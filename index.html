<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Matemático Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Open+Sans:wght@400;600&display=swap');
        body { background: #fff; font-family: 'Open Sans', sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: #F2F2F2; padding: 30px; border-radius: 40px; width: 100%; max-width: 850px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 15px 40px rgba(0,0,0,0.05); position: relative; }
        .header { text-align: center; margin-bottom: 15px; width: 100%; position: relative; }
        .header h1 { font-family: 'Playfair Display', serif; font-size: 28px; margin: 0; }
        
        /* Nuevo Selector de Color Discreto */
        .color-wrapper { position: absolute; top: 0; right: 0; }
        .color-trigger { width: 25px; height: 25px; border-radius: 4px; border: 2px solid #ddd; cursor: pointer; background-color: #000; transition: 0.2s; }
        .color-trigger:hover { border-color: #999; }
        #hidden-color-input { position: absolute; top: 0; right: 0; width: 25px; height: 25px; opacity: 0; cursor: pointer; }

        /* Menú de Píldoras */
        .pill-menu { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; justify-content: center; background: #e0e0e0; padding: 5px; border-radius: 30px; }
        .pill-btn { padding: 10px 25px; border-radius: 25px; border: none; background: transparent; font-weight: 600; font-size: 13px; cursor: pointer; color: #666; transition: 0.2s; flex: 1; text-align: center; }
        .pill-btn.active { background: #fff; color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .grids-container { width: 100%; margin-bottom: 15px; }
        .symbol-grid { display: none; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; padding: 15px; background: #fff; border-radius: 20px; border: 1px solid #ddd; }
        .symbol-grid.active { display: grid; }

        /* Visor */
        .preview-box { background: white; border-radius: 25px; margin-bottom: 20px; width: 100%; min-height: 150px; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd; overflow: hidden; }
        #math-target { padding: 30px; display: inline-block; transition: opacity 0.2s; }

        /* Botones de Símbolos */
        .btn-sym { background: #f9f9f9; border: 1px solid #eee; padding: 10px 5px; border-radius: 12px; cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: 0.1s; }
        .btn-sym:hover { background: #000; color: #fff; border-color: #000; }
        .btn-sym b { font-size: 18px; margin-bottom: 4px; }
        .btn-sym span { font-size: 9px; font-weight: 700; text-transform: uppercase; opacity: 0.6; }

        /* Área de Texto y Acciones */
        textarea { width: 100%; padding: 20px; border-radius: 20px; border: 1px solid #ccc; font-size: 16px; font-family: 'Courier New', monospace; outline: none; resize: vertical; min-height: 100px; margin-bottom: 15px; text-align: center; }
        .actions { display: flex; gap: 10px; width: 100%; }
        select { padding: 15px; border-radius: 25px; border: 1px solid #ccc; flex: 1; font-weight: 600; outline: none; cursor: pointer; }
        .btn-dl { flex: 2; background: #000; color: #fff; border: none; padding: 15px; border-radius: 30px; font-size: 15px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-dl:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Editor de expresiones</h1>
        <div class="color-wrapper">
            <div class="color-trigger" id="color-trigger" title="Cambiar Color"></div>
            <input type="color" id="hidden-color-input" value="#000000">
        </div>
    </div>

    <div class="pill-menu" id="pill-menu"></div>
    <div class="grids-container" id="grids-container"></div>

    <div class="preview-box">
        <div id="math-target">\[ ... \]</div>
    </div>

    <textarea id="math-input" spellcheck="false" placeholder="Escribe código LaTeX aquí..."></textarea>

    <div class="actions">
        <select id="res-val">
            <option value="1.2">Calidad Baja</option>
            <option value="2.8" selected>Calidad Media</option>
            <option value="4.5">Calidad Alta</option>
        </select>
        <button class="btn-dl" onclick="optimizedExport()">Descargar PNG</button>
    </div>
</div>

<script>
    // ================= CONFIGURACIÓN Y ESTADO =================
    const menus = {
        "Álgebra": [
            {n: 'Fracc', s: '\\frac{a}{b}', i: '÷'}, {n: 'Raiz', s: '\\sqrt{x}', i: '√'},
            {n: 'Potencia', s: 'x^{n}', i: 'xⁿ'}, {n: 'Sist.', s: '\\begin{cases} x=1 \\\\ y=2 \\end{cases}', i: '{='},
            {n: 'Matriz', s: '\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix}', i: '[M]'}
        ],
        "Cálculo": [
            {n: 'Integral', s: '\\int_{a}^{b} ', i: '∫'}, {n: 'Derivada', s: '\\frac{dy}{dx}', i: 'dy'},
            {n: 'Suma', s: '\\sum_{i=1}^{n}', i: '∑'}, {n: 'Límite', s: '\\lim_{x \to \infty}', i: 'lim'}
        ],
        "Símbolos": [
            {n: 'Espacio', s: '\\: ', i: '␣'}, {n: 'Infinito', s: '\\infty', i: '∞'},
            {n: 'Pi', s: '\\pi', i: 'π'}, {n: 'Alfa', s: '\\alpha', i: 'α'},
            {n: 'Beta', s: '\\beta', i: 'β'}, {n: 'Texto', s: '\\text{abc}', i: 'T'}
        ],
        "Letras Griegas": [
            {n: 'Alpha', s: '\\alpha', i: 'α'},
            {n: 'Beta', s: '\\beta', i: 'β'},
            {n: 'Gamma', s: '\\gamma', i: 'γ'},
            {n: 'Delta', s: '\\delta', i: 'δ'},
            {n: 'Epsilon', s: '\\epsilon', i: 'ε'},
            {n: 'Zeta', s: '\\zeta', i: 'ζ'},
            {n: 'Theta', s: '\\theta', i: 'θ'},
            {n: 'Lambda', s: '\\lambda', i: 'λ'},
            {n: 'Mu', s: '\\mu', i: 'μ'},
            {n: 'Pi', s: '\\pi', i: 'π'},
            {n: 'Rho', s: '\\rho', i: 'ρ'},
            {n: 'Sigma', s: '\\sigma', i: 'σ'},
            {n: 'Tau', s: '\\tau', i: 'τ'},
            {n: 'Phi', s: '\\phi', i: 'φ'},
            {n: 'Omega', s: '\\omega', i: 'ω'},
            {n: 'Delta M.', s: '\\Delta', i: 'Δ'},
            {n: 'Sigma M.', s: '\\Sigma', i: 'Σ'},
            {n: 'Omega M.', s: '\\Omega', i: 'Ω'}
        ]
    };
    let renderTimer;
    let currentColor = '#000000';
    const inputArea = document.getElementById('math-input');
    const display = document.getElementById('math-target');
    const colorInput = document.getElementById('hidden-color-input');
    const colorTrigger = document.getElementById('color-trigger');

    // ================= INICIALIZACIÓN =================
    function init() {
        // Crear menú de píldoras
        const pillContainer = document.getElementById('pill-menu');
        const gridsContainer = document.getElementById('grids-container');
        let first = true;
        for (let cat in menus) {
            // Crear botón de píldora
            let pill = document.createElement('button');
            pill.className = `pill-btn ${first ? 'active' : ''}`;
            pill.textContent = cat;
            pill.onclick = () => switchTab(cat);
            pillContainer.appendChild(pill);
            
            // Crear rejilla de símbolos
            let grid = document.createElement('div');
            grid.className = `symbol-grid ${first ? 'active' : ''}`;
            grid.id = `grid-${cat}`;
            menus[cat].forEach(item => {
                let b = document.createElement('button');
                b.className = 'btn-sym';
                b.onclick = () => insertSymbol(item.s);
                b.innerHTML = `<b>${item.i}</b><span>${item.n}</span>`;
                grid.appendChild(b);
            });
            gridsContainer.appendChild(grid);
            first = false;
        }

        // Configurar inputs
        inputArea.value = "\\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}";
        colorInput.addEventListener('input', updateColor);
        inputArea.addEventListener('input', () => {
            clearTimeout(renderTimer);
            renderTimer = setTimeout(render, 350);
        });
        render();
    }

    // ================= LÓGICA DE INTERFAZ =================
    function switchTab(catName) {
        document.querySelectorAll('.pill-btn').forEach(b => b.classList.toggle('active', b.textContent === catName));
        document.querySelectorAll('.symbol-grid').forEach(g => g.classList.toggle('active', g.id === `grid-${catName}`));
    }

    function updateColor(e) {
        currentColor = e.target.value;
        colorTrigger.style.backgroundColor = currentColor;
        render();
    }

    function insertSymbol(code) {
        let s = inputArea.selectionStart;
        inputArea.value = inputArea.value.substring(0, s) + code + inputArea.value.substring(inputArea.selectionEnd);
        inputArea.focus();
        render();
    }

    // ================= RENDERIZADO Y EXPORTACIÓN (INTACTOS) =================
    function render() {
        display.style.opacity = "0.4";
        const rawContent = inputArea.value || '\\text{...}';
        display.innerHTML = `\\[ \\color{${currentColor}}{${rawContent}} \\]`;
        MathJax.typesetPromise([display]).then(() => { display.style.opacity = "1"; });
    }

    async function optimizedExport() {
        const svg = display.querySelector('svg');
        if (!svg) return;
        const btn = document.querySelector('.btn-dl');
        btn.innerText = "Procesando...";
        const requestedScale = parseFloat(document.getElementById('res-val').value);
        const bbox = svg.viewBox.baseVal;
        const maxDimension = 4500; // Límite de seguridad
        let finalScale = requestedScale;
        if (bbox.width * finalScale > maxDimension) finalScale = maxDimension / bbox.width;
        if (bbox.height * finalScale > maxDimension) finalScale = Math.min(finalScale, maxDimension / bbox.height);
        
        const canvas = document.createElement('canvas');
        const padding = 30 * finalScale;
        canvas.width = (bbox.width * finalScale) + padding;
        canvas.height = (bbox.height * finalScale) + padding;
        const ctx = canvas.getContext('2d');
        const svgData = new XMLSerializer().serializeToString(svg);
        const img = new Image();
        const blob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        img.onload = () => {
            ctx.drawImage(img, padding/2, padding/2, bbox.width * finalScale, bbox.height * finalScale);
            canvas.toBlob((b) => {
                const link = document.createElement('a');
                link.download = `math_formula_${Date.now()}.png`;
                link.href = URL.createObjectURL(b);
                link.click();
                URL.revokeObjectURL(url);
                btn.innerText = "Descargar PNG";
            }, 'image/png', 1.0);
        };
        img.src = url;
    }
    window.onload = init;
</script>
</body>
</html>
