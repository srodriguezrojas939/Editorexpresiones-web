<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Matemático Estable</title>

    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Open+Sans:wght@400;600&display=swap');

        body { background: #fff; font-family: 'Open Sans', sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; }

        .container {
            background: #F2F2F2; padding: 25px; border-radius: 35px;
            width: 100%; max-width: 800px; display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { font-family: 'Playfair Display', serif; font-size: 28px; margin: 0; }

        /* Visor optimizado */
        .preview-box {
            background: white; border-radius: 20px; margin-bottom: 20px;
            width: 100%; min-height: 120px; display: flex; align-items: center; 
            justify-content: center; border: 1px solid #ddd; overflow-x: auto;
        }
        
        #math-target { padding: 25px; display: inline-block; }

        /* Menús internos */
        .toolbar { width: 100%; margin-bottom: 15px; }
        details { background: white; border-radius: 12px; margin-bottom: 5px; border: 1px solid #e0e0e0; }
        summary { padding: 10px 15px; font-weight: 600; font-size: 13px; cursor: pointer; color: #444; list-style: none; }
        
        .grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); 
            gap: 5px; padding: 10px; border-top: 1px solid #eee;
        }

        .btn-sym {
            background: #fdfdfd; border: 1px solid #ddd; padding: 8px 2px; border-radius: 8px;
            cursor: pointer; display: flex; flex-direction: column; align-items: center; transition: 0.1s;
        }
        .btn-sym:hover { background: #000; color: #fff; }
        .btn-sym b { font-size: 16px; margin-bottom: 2px; }
        .btn-sym span { font-size: 8px; font-weight: 700; text-transform: uppercase; opacity: 0.6; }

        textarea {
            width: 100%; padding: 15px; border-radius: 15px; border: 1px solid #ccc;
            font-size: 15px; font-family: 'Courier New', monospace; outline: none;
            resize: vertical; min-height: 80px; margin-bottom: 15px; text-align: center;
        }

        .actions { display: flex; gap: 8px; width: 100%; }
        select { padding: 12px; border-radius: 15px; border: 1px solid #ccc; flex: 1; font-weight: 600; cursor: pointer; }
        
        .btn-dl {
            flex: 2; background: #000; color: #fff; border: none;
            padding: 12px; border-radius: 25px; font-size: 14px; font-weight: 700;
            cursor: pointer; transition: 0.2s;
        }
        .btn-dl:hover { opacity: 0.8; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Editor de expresiones</h1>
    </div>

    <div class="preview-box">
        <div id="math-target">\[ ... \]</div>
    </div>

    <div class="toolbar" id="toolbar"></div>

    <textarea id="math-input" spellcheck="false" placeholder="Escribe aquí..."></textarea>

    <div class="actions">
        <select id="res-val">
            <option value="1.2">Calidad Baja</option>
            <option value="2.5" selected>Calidad Media</option>
            <option value="4.0">Calidad Alta</option>
        </select>
        <button class="btn-dl" onclick="safeExport()">Descargar PNG</button>
    </div>
</div>

<script>
    const config = {
        "Álgebra": [
            {n: 'Fracc', s: '\\frac{a}{b}', i: '÷'}, {n: 'Raiz', s: '\\sqrt{x}', i: '√'},
            {n: 'Sist', s: '\\begin{cases} x=1 \\\\ y=2 \\end{cases}', i: '{='}, {n: 'Matriz', s: '\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix}', i: '[M]'}
        ],
        "Cálculo": [
            {n: 'Integ', s: '\\int_{a}^{b} ', i: '∫'}, {n: 'Deriv', s: '\\frac{dy}{dx}', i: 'dy'},
            {n: 'Suma', s: '\\sum_{i=1}^{n}', i: '∑'}, {n: 'Lím', s: '\\lim_{x \\to \\infty}', i: 'lim'}
        ],
        "Extras": [
            {n: 'Espacio', s: '\\: ', i: '␣'}, {n: 'Texto', s: '\\text{ }', i: 'Abc'},
            {n: 'Inf', s: '\\infty', i: '∞'}, {n: 'Pi', s: '\\pi', i: 'π'}
        ]
    };

    let timer;
    const inputArea = document.getElementById('math-input');
    const display = document.getElementById('math-target');

    function init() {
        const tb = document.getElementById('toolbar');
        for (let cat in config) {
            let d = document.createElement('details');
            let g = document.createElement('div');
            g.className = 'grid';
            d.innerHTML = `<summary>${cat}</summary>`;
            config[cat].forEach(item => {
                let b = document.createElement('button');
                b.className = 'btn-sym';
                b.onclick = () => {
                    let s = inputArea.selectionStart;
                    inputArea.value = inputArea.value.substring(0, s) + item.s + inputArea.value.substring(inputArea.selectionEnd);
                    inputArea.focus();
                    render();
                };
                b.innerHTML = `<b>${item.i}</b><span>${item.n}</span>`;
                g.appendChild(b);
            });
            d.appendChild(g);
            tb.appendChild(d);
        }
        inputArea.value = "\\frac{x^2 + 1}{\\sqrt{\\frac{1}{x}}}"; 
        render();
    }

    inputArea.addEventListener('input', () => {
        clearTimeout(timer);
        timer = setTimeout(render, 400); // Mayor retraso para evitar lag
    });

    function render() {
        display.style.opacity = "0.4";
        display.innerHTML = `\\[ ${inputArea.value || '\\text{...}'} \\]`;
        MathJax.typesetPromise([display]).then(() => {
            display.style.opacity = "1";
        });
    }

    async function safeExport() {
        const svg = display.querySelector('svg');
        if (!svg) return;

        const btn = document.querySelector('.btn-dl');
        btn.innerText = "Guardando...";
        
        const scale = parseFloat(document.getElementById('res-val').value);
        
        // Obtener dimensiones reales del SVG
        const bbox = svg.viewBox.baseVal;
        const w = bbox.width * scale;
        const h = bbox.height * scale;

        // Límite de seguridad: Si la imagen es mayor a 5000px, reducir escala
        let finalScale = scale;
        if (h > 4000 || w > 4000) {
            alert("Expresión muy grande. Se ajustará la calidad para evitar errores.");
            finalScale = 1.0; 
        }

        const canvas = document.createElement('canvas');
        canvas.width = (bbox.width * finalScale) + (20 * finalScale);
        canvas.height = (bbox.height * finalScale) + (20 * finalScale);
        
        const ctx = canvas.getContext('2d');
        const svgData = new XMLSerializer().serializeToString(svg);
        const img = new Image();
        const blob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(blob);

        img.onload = () => {
            ctx.drawImage(img, 10 * finalScale, 10 * finalScale, bbox.width * finalScale, bbox.height * finalScale);
            canvas.toBlob((b) => {
                const link = document.createElement('a');
                link.download = `math_${Date.now()}.png`;
                link.href = URL.createObjectURL(b);
                link.click();
                URL.revokeObjectURL(url);
                btn.innerText = "Descargar PNG";
            }, 'image/png');
        };
        img.src = url;
    }

    window.onload = init;
</script>

</body>
</html>
