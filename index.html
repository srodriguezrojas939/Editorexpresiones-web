<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Expresiones Matemáticas</title>

    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" id="MathJax-script" async></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap');

        body { 
            background: #ffffff; 
            font-family: 'Open Sans', sans-serif; 
            margin: 0; 
            display: flex; 
            height: 100vh;
            color: #333;
        }

        /* Estructura Principal */
        .main-wrapper {
            display: flex;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            gap: 20px;
            padding: 20px;
        }

        /* Lateral Izquierdo: Menús */
        .sidebar {
            width: 280px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            padding-right: 10px;
        }

        /* Área de Edición Derecha */
        .editor-main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #F2F2F2;
            padding: 30px;
            border-radius: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        .header-section { text-align: left; margin-bottom: 10px; }
        .header-section h1 { font-family: 'Playfair Display', serif; font-size: 28px; margin: 0; }
        .header-section p { font-family: 'Playfair Display', serif; font-size: 16px; margin: 5px 0; color: #666; }

        /* Visor Adaptativo */
        .preview-container {
            background: white;
            border-radius: 20px;
            border: 1px solid #ddd;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 20px;
        }

        /* Este es el div que se captura. Es inline-block para que se ajuste al contenido */
        #capture-area {
            display: inline-block;
            padding: 15px;
            background: transparent;
        }

        /* Estilo de los Menús Laterales */
        details {
            background: #f8f8f8;
            border-radius: 12px;
            border: 1px solid #eee;
            transition: 0.3s;
        }
        details[open] { background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        summary {
            padding: 10px 15px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            list-style: none;
            display: flex;
            justify-content: space-between;
            color: #555;
        }
        summary::-webkit-details-marker { display: none; }
        summary::after { content: '▾'; color: #aaa; }
        details[open] summary::after { content: '▴'; }

        .symbol-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            padding: 10px;
        }
        .sym-btn {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 5px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .sym-btn:hover { background: #000; color: #fff; border-color: #000; }

        /* Input y Botones */
        textarea {
            width: 100%;
            height: 120px;
            padding: 20px;
            border-radius: 20px;
            border: 1px solid #ccc;
            font-family: 'Courier New', monospace;
            font-size: 15px;
            outline: none;
            resize: none;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        select {
            padding: 12px;
            border-radius: 15px;
            border: 1px solid #ccc;
            font-size: 14px;
            outline: none;
            flex-grow: 1;
        }
        .btn-download {
            background: black;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            font-size: 14px;
        }
        .btn-download:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="sidebar" id="sidebar-menus">
        </div>

    <div class="editor-main">
        <div class="header-section">
            <h1>Editor de expresiones</h1>
            <p>√(Raiz) Cuadrada²</p>
        </div>

        <div class="preview-container">
            <div id="capture-area">
                <div id="latex-output">\[ \frac{df}{dx} = \int_{0}^{\infty} e^{-x^2} dx \]</div>
            </div>
        </div>

        <textarea id="latex-input" oninput="renderMath()" placeholder="Escribe tu código LaTeX aquí...">\frac{df}{dx} = \int_{0}^{\infty} e^{-x^2} dx</textarea>

        <div class="controls">
            <select id="quality-res">
                <option value="2">Calidad Media</option>
                <option value="5" selected>Calidad Alta</option>
                <option value="10">Calidad Ultra (Máxima)</option>
            </select>
            <button class="btn-download" onclick="downloadImage()">Descargar PNG</button>
        </div>
    </div>
</div>

<script>
    const categories = {
        "Fundamentales": [
            {l: 'Espacio', v: '\\: '}, {l: 'Espacio+', v: '\\quad '}, {l: 'Texto', v: '\\text{...}'},
            {l: '±', v: '\\pm '}, {l: '≠', v: '\\neq '}, {l: '≈', v: '\\approx '}, {l: '∞', v: '\\infty '}
        ],
        "Álgebra": [
            {l: 'Fracción', v: '\\frac{a}{b}'}, {l: 'Potencia', v: 'x^{n}'}, {l: 'Subíndice', v: 'x_{n}'},
            {l: 'Raíz', v: '\\sqrt{x}'}, {l: 'Raíz N', v: '\\sqrt[n]{x}'}, {l: 'Sistema', v: '\\begin{cases} x+y=1 \\\\ x-y=2 \\end{cases}'}
        ],
        "Cálculo": [
            {l: 'Derivada', v: '\\frac{d}{dx}'}, {l: 'D.Parcial', v: '\\frac{\\partial}{\\partial x}'},
            {l: 'Integral', v: '\\int_{a}^{b} f(x) dx'}, {l: 'Límite', v: '\\lim_{x \\to \\infty}'},
            {l: 'Sumatoria', v: '\\sum_{i=0}^{n}'}, {l: 'Productoria', v: '\\prod_{i=1}^{n}'}
        ],
        "Conjuntos": [
            {l: 'Pertenece', v: '\\in '}, {l: 'Subconj.', v: '\\subset '}, {l: 'Unión', v: '\\cup '},
            {l: 'Intersec.', v: '\\cap '}, {l: 'Reales', v: '\\mathbb{R}'}, {l: 'Complejos', v: '\\mathbb{C}'}
        ],
        "Matrices": [
            {l: 'Matriz ( )', v: '\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix}'},
            {l: 'Matriz [ ]', v: '\\begin{bmatrix} a & b \\\\ c & d \\end{bmatrix}'},
            {l: 'Det | |', v: '\\begin{vmatrix} a & b \\\\ c & d \\end{vmatrix}'}
        ],
        "Lógicos": [
            {l: 'Para todo', v: '\\forall '}, {l: 'Existe', v: '\\exists '}, {l: 'Entonces', v: '\\implies '},
            {l: 'Si y solo si', v: '\\iff '}, {l: 'Por tanto', v: '\\therefore '}
        ]
    };

    function initCategories() {
        const sidebar = document.getElementById('sidebar-menus');
        for (let catName in categories) {
            const det = document.createElement('details');
            const sum = document.createElement('summary');
            sum.textContent = catName;
            
            const grid = document.createElement('div');
            grid.className = 'symbol-grid';

            categories[catName].forEach(sym => {
                const btn = document.createElement('button');
                btn.className = 'sym-btn';
                btn.textContent = sym.l;
                btn.onclick = () => insertSnippet(sym.v);
                grid.appendChild(btn);
            });

            det.appendChild(sum);
            det.appendChild(grid);
            sidebar.appendChild(det);
        }
    }

    function insertSnippet(text) {
        const area = document.getElementById('latex-input');
        const start = area.selectionStart;
        const end = area.selectionEnd;
        area.value = area.value.substring(0, start) + text + area.value.substring(end);
        area.focus();
        renderMath();
    }

    function renderMath() {
        const input = document.getElementById('latex-input').value;
        const output = document.getElementById('latex-output');
        output.innerHTML = `\\[ ${input} \\]`;
        MathJax.typesetPromise([output]);
    }

    async function downloadImage() {
        const target = document.getElementById('capture-area');
        const quality = document.getElementById('quality-res').value;
        const btn = document.querySelector('.btn-download');
        
        btn.innerText = "Procesando...";
        btn.disabled = true;

        // Esperar a que MathJax termine de renderizar antes de capturar
        await MathJax.typesetPromise();

        try {
            const canvas = await html2canvas(target, {
                backgroundColor: null, // Transparente
                scale: parseFloat(quality),
                logging: false,
                useCORS: true,
                // Estos parámetros ayudan a evitar el overlap de fuentes
                removeContainer: true
            });

            const link = document.createElement('a');
            link.download = 'expresion.png';
            link.href = canvas.toDataURL("image/png");
            link.click();
        } catch (e) {
            alert("Error al generar la imagen");
        } finally {
            btn.innerText = "Descargar PNG";
            btn.disabled = false;
        }
    }

    window.onload = () => {
        initCategories();
        renderMath();
    };
</script>

</body>
</html>
