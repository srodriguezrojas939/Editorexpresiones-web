<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Expresiones Pro</title>

    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" id="MathJax-script" async></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap');

        body { 
            background: #ffffff; 
            font-family: 'Open Sans', sans-serif; 
            margin: 0; 
            padding: 20px;
            display: flex; 
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .calculadora {
            background: #F2F2F2; 
            padding: 40px; 
            border-radius: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.06); 
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center; /* Centra todo el contenido */
        }

        .header-section { text-align: center; margin-bottom: 25px; }
        .header-section h1 { font-family: 'Playfair Display', serif; font-size: 32px; margin: 0; font-weight: 600; }
        .header-section p { font-family: 'Playfair Display', serif; font-size: 18px; margin: 5px 0; color: #555; }

        /* Visor Mejorado */
        .preview-box {
            background: white; 
            border-radius: 25px; 
            margin-bottom: 25px;
            width: 100%;
            min-height: 160px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            border: 1px solid #ddd;
            overflow: visible; /* Importante para que no corte símbolos */
        }
        
        /* El contenedor que será capturado */
        #math-display {
            padding: 30px;
            display: inline-block;
        }

        /* Menús Desplegables Internos */
        .toolbar { width: 100%; margin-bottom: 20px; }
        details { 
            background: white; 
            border-radius: 15px; 
            margin-bottom: 8px; 
            border: 1px solid #e0e0e0;
            width: 100%;
        }
        summary { 
            padding: 12px 20px; 
            font-weight: 600; 
            font-size: 14px; 
            cursor: pointer; 
            list-style: none;
            color: #444;
        }
        
        .symbol-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); 
            gap: 8px; 
            padding: 15px; 
            border-top: 1px solid #eee;
        }

        /* Botones con símbolo ARRIBA y nombre ABAJO */
        .sym-btn {
            background: #f9f9f9; 
            border: 1px solid #ddd; 
            padding: 10px 5px; 
            border-radius: 12px;
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 5px;
            transition: 0.2s;
        }
        .sym-btn:hover { background: #000; color: white; border-color: #000; }
        .sym-btn .big-icon { font-size: 20px; font-family: serif; font-weight: bold; }
        .sym-btn .small-label { font-size: 10px; font-weight: 600; text-transform: uppercase; opacity: 0.8; }

        /* Area de Texto */
        textarea {
            width: 100%; 
            padding: 20px; 
            border-radius: 25px; 
            border: 1px solid #ccc;
            box-sizing: border-box; 
            font-size: 16px; 
            font-family: 'Courier New', monospace;
            outline: none; 
            resize: none; 
            min-height: 100px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Controles de Descarga */
        .download-zone {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        select { 
            padding: 15px; 
            border-radius: 30px; 
            border: 1px solid #ccc; 
            outline: none; 
            flex: 1;
            font-weight: 600;
        }
        .btn-descargar {
            flex: 2;
            background: black; 
            color: white; 
            border: none;
            padding: 18px; 
            border-radius: 35px; 
            font-size: 16px; 
            font-weight: 700;
            cursor: pointer; 
            transition: 0.3s;
        }
        .btn-descargar:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="calculadora">
    <div class="header-section">
        <h1>Editor de expresiones</h1>
        <p>√(Raiz) Cuadrada²</p>
    </div>

    <div class="preview-box">
        <div id="math-display">\[ \text{Cargando...} \]</div>
    </div>

    <div class="toolbar" id="toolbar">
        </div>

    <textarea id="latex-input" oninput="render()" placeholder="Escribe aquí..."></textarea>

    <div class="download-zone">
        <select id="quality">
            <option value="2">Calidad Media</option>
            <option value="5" selected>Calidad Alta</option>
            <option value="10">Calidad Ultra (4K)</option>
        </select>
        <button class="btn-descargar" onclick="downloadPNG()">Descargar PNG</button>
    </div>
</div>

<script>
    const buttons = {
        "Fundamentales": [
            {t: 'espacio', s: '\\: ', n: '\\text{␣}'}, {t: 'quad', s: '\\quad ', n: '\\text{␣␣}'},
            {t: 'fracción', s: '\\frac{a}{b}', n: '÷'}, {t: 'raíz', s: '\\sqrt{x}', n: '√'},
            {t: 'potencia', s: 'x^{n}', n: 'xⁿ'}, {t: 'subíndice', s: 'x_{n}', n: 'xₙ'}
        ],
        "Cálculo": [
            {t: 'integral', s: '\\int ', n: '∫'}, {t: 'derivada', s: '\\frac{d}{dx}', n: 'd/dx'},
            {t: 'parcial', s: '\\frac{\\partial}{\\partial x}', n: '∂x'}, {t: 'límite', s: '\\lim_{x \\to \\infty}', n: 'lim'},
            {t: 'suma', s: '\\sum_{i=1}^{n}', n: '∑'}, {t: 'infinito', s: '\\infty', n: '∞'}
        ],
        "Álgebra": [
            {t: 'sistema', s: '\\begin{cases} x=1 \\\\ y=2 \\end{cases}', n: '{='},
            {t: 'matriz', s: '\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix}', n: '[M]'},
            {t: 'vector', s: '\\vec{v}', n: 'v⃗'}, {t: 'log', s: '\\log_{b}(x)', n: 'log'}
        ],
        "Lógica": [
            {t: 'para todo', s: '\\forall ', n: '∀'}, {t: 'existe', s: '\\exists ', n: '∃'},
            {t: 'implica', s: '\\implies ', n: '⇒'}, {t: 'equival', s: '\\iff ', n: '⇔'}
        ]
    };

    function initToolbar() {
        const tb = document.getElementById('toolbar');
        for (let cat in buttons) {
            const det = document.createElement('details');
            const sum = document.createElement('summary');
            sum.textContent = cat;
            const grid = document.createElement('div');
            grid.className = 'symbol-grid';

            buttons[cat].forEach(b => {
                const btn = document.createElement('button');
                btn.className = 'sym-btn';
                btn.onclick = () => insert(b.s);
                btn.innerHTML = `<span class="big-icon">${b.n}</span><span class="small-label">${b.t}</span>`;
                grid.appendChild(btn);
            });

            det.appendChild(sum);
            det.appendChild(grid);
            tb.appendChild(det);
        }
    }

    function insert(code) {
        const el = document.getElementById('latex-input');
        const start = el.selectionStart;
        el.value = el.value.substring(0, start) + code + el.value.substring(el.selectionEnd);
        el.focus();
        render();
    }

    function render() {
        const input = document.getElementById('latex-input').value;
        const out = document.getElementById('math-display');
        out.innerHTML = `\\[ ${input || '\\text{Escribe algo...}'} \\]`;
        MathJax.typesetPromise([out]);
    }

    // FUNCIÓN MAESTRA: Convierte el SVG de MathJax a PNG sin errores de capas
    async function downloadPNG() {
        const display = document.querySelector('#math-display svg');
        if (!display) return alert("Escribe algo primero");

        const scale = document.getElementById('quality').value;
        const btn = document.querySelector('.btn-descargar');
        btn.innerText = "Procesando...";

        try {
            // 1. Clonamos el SVG para no romper la vista real
            const svgClone = display.cloneNode(true);
            const width = display.viewBox.baseVal.width * scale;
            const height = display.viewBox.baseVal.height * scale;

            svgClone.setAttribute('width', width);
            svgClone.setAttribute('height', height);

            // 2. Serializar SVG a String
            const svgData = new XMLSerializer().serializeToString(svgClone);
            const canvas = document.createElement('canvas');
            canvas.width = width + (40 * scale); // Margen
            canvas.height = height + (40 * scale);
            const ctx = canvas.getContext('2d');

            const img = new Image();
            const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
            const url = URL.createObjectURL(svgBlob);

            img.onload = function() {
                ctx.drawImage(img, 20 * scale, 20 * scale);
                const pngUrl = canvas.toDataURL("image/png");
                const link = document.createElement('a');
                link.download = 'expresion_matematica.png';
                link.href = pngUrl;
                link.click();
                URL.revokeObjectURL(url);
                btn.innerText = "Descargar PNG";
            };
            img.src = url;

        } catch (e) {
            console.error(e);
            btn.innerText = "Error";
        }
    }

    window.onload = () => {
        initToolbar();
        document.getElementById('latex-input').value = "\\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}";
        render();
    };
</script>

</body>
</html>
